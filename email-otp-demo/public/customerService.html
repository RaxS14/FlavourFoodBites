<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Service Portal</title>
<style>
:root {
  --primary: #FF6B35;
  --background: #0F0F23;
  --background-light: #1a1a3a;
  --text-primary: #FFF;
  --text-secondary: #B8BCC8;
  --glass-bg: rgba(255,255,255,0.1);
  --glass-border: rgba(255,255,255,0.2);
  --gradient: linear-gradient(135deg,#FF6B35 0%,#E55A2B 50%,#FF8A50 100%);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--background);color:var(--text-primary);display:flex;flex-direction:column;min-height:100vh;}
header{position:fixed;top:0;left:0;right:0;background:rgba(15,15,35,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-border);z-index:1000;}
.navbar{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;max-width:1400px;margin:0 auto;}
.logo-section{display:flex;align-items:center;gap:1rem;}
.logo{width:60px;height:60px;background:var(--gradient);border-radius:16px;display:flex;justify-content:center;align-items:center;font-size:1.8rem;font-weight:bold;animation:floatLogo 3s ease-in-out infinite;}
@keyframes floatLogo{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
.brand-name{font-size:1.8rem;font-weight:800;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-links{display:flex;list-style:none;gap:1.5rem;}
.nav-links a{text-decoration:none;color:var(--text-secondary);font-weight:600;padding:0.5rem 1rem;border-radius:12px;transition:all .3s ease;}
.nav-links a:hover,.nav-links a.active{color:var(--text-primary);transform:translateY(-2px);}
main{flex:1;margin-top:100px;display:flex;flex-direction:column;align-items:center;padding:2rem;gap:2rem;width:100%;}
.form-container,.tickets-container{background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:24px;padding:2rem;width:100%;max-width:600px;}
h2{text-align:center;margin-bottom:1rem;color:var(--primary);}
.form-input,.form-textarea,.form-file{width:100%;padding:0.75rem 1rem;margin-bottom:1rem;border-radius:12px;border:1px solid var(--glass-border);background:var(--background-light);color:var(--text-primary);font-size:1rem;}
.form-textarea{resize:none;}
.submit-btn{width:100%;padding:1rem;border:none;border-radius:12px;background:var(--gradient);color:#fff;font-weight:700;cursor:pointer;transition:all .3s ease;}
.submit-btn:hover{opacity:.9;transform:translateY(-2px);}
.ticket-card{background:var(--background-light);border-radius:16px;padding:1rem;margin-bottom:1rem;}
.ticket-images{display:flex;flex-wrap:wrap;gap:.5rem;}
.ticket-images img{max-width:100px;max-height:100px;border-radius:8px;object-fit:cover;cursor:pointer;transition:transform .2s;}
.ticket-images img:hover{transform:scale(1.1);}
.ticket-chat-btn{margin-top:.5rem;background:var(--gradient);color:#fff;font-weight:600;padding:.5rem;border-radius:12px;cursor:pointer;border:none;width:100%;transition:all .3s ease;}
.ticket-chat-btn:hover{opacity:.9;transform:translateY(-2px);}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:10000;}
.modal img{max-width:90%;max-height:90%;border-radius:12px;}
.chat-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:10000;}
.chat-content{background:var(--background-light);border-radius:16px;padding:1rem;width:90%;max-width:400px;height:70%;display:flex;flex-direction:column;}
#chat-box{flex:1;overflow-y:auto;background:rgba(255,255,255,.05);padding:.75rem;border-radius:8px;margin-bottom:.5rem;}
.chat-input-container{display:flex;gap:.5rem;}
.chat-input-container input[type=file]{width:80px;}
.star{cursor:pointer;color:gray;font-size:2rem;transition:transform .2s,color .2s;}
.star:hover,.star.selected{color:var(--primary);transform:scale(1.3);}
.feedback-input{width:80%;padding:.5rem;border-radius:8px;border:1px solid var(--glass-border);background:var(--background-light);color:white;margin-bottom:1rem;}
</style>
</head>
<body>

<header>
  <nav class="navbar">
    <div class="logo-section">
      <div class="logo">CS</div>
      <span class="brand-name">Customer Service</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="customerService.html" class="active">Support</a></li>
      <li><a href="login.html">Logout</a></li>
    </ul>
  </nav>
</header>

<main>
  <!-- Ticket Form -->
  <div class="form-container">
    <h2>Submit a Ticket</h2>
    <form id="ticket-form">
      <input type="text" id="name" class="form-input" placeholder="Full Name" required>
      <input type="email" id="email" class="form-input" placeholder="Email" required>
      <input type="text" id="subject" class="form-input" placeholder="Subject" required>
      <textarea id="message" class="form-textarea" rows="5" placeholder="Message" required></textarea>
      <input type="file" id="images" class="form-file" accept="image/*" multiple>
      <button type="submit" class="submit-btn">Send Ticket</button>
    </form>
  </div>

  <!-- Ticket List -->
  <div class="tickets-container">
    <h2>My Tickets</h2>
    <div id="tickets-list"></div>
  </div>

  <!-- Chat Modal -->
  <div id="chat-modal" class="chat-modal">
    <div class="chat-content">
      <h3 style="text-align:center;">Live Chat</h3>
      <div id="chat-box"></div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type a message...">
        <input type="file" id="chat-files" accept="image/*" multiple>
        <button id="send-chat" class="submit-btn">Send</button>
      </div>
      <button id="download-chat" class="submit-btn" style="margin-top:0.5rem;">üíæ Download Chat</button>
      <button id="end-chat" class="submit-btn" style="margin-top:0.5rem;background:#e74c3c;">üö™ End Chat</button>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="image-modal" class="modal"><img id="modal-img" src=""></div>

  <!-- Rating Modal -->
  <div id="rating-modal" class="modal" style="flex-direction:column;text-align:center;">
    <h2>Rate Your Chat Experience</h2>
    <div id="stars" style="display:flex;justify-content:center;gap:1rem;margin:1rem 0;">
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
    </div>
    <textarea id="feedback" class="feedback-input" placeholder="Write feedback (optional)..."></textarea>
    <p id="thank-you" style="display:none;color:var(--primary);font-weight:600;">Thank you for your feedback! üí¨</p>
  </div>
</main>

<script>
async function readFiles(files){
  return Promise.all([...files].slice(0,5).map(f=>new Promise(r=>{
    const reader=new FileReader();
    reader.onload=e=>r(e.target.result);
    reader.readAsDataURL(f);
  })));
}
function openImage(src){ 
  document.getElementById('modal-img').src=src; 
  document.getElementById('image-modal').style.display='flex'; 
}

const form=document.getElementById('ticket-form');
const ticketsList=document.getElementById('tickets-list');
let currentTicket=null;

function renderTickets(){
  const tickets=JSON.parse(localStorage.getItem('tickets')||'[]');
  ticketsList.innerHTML='';
  tickets.forEach(t=>{
    const rating=localStorage.getItem(`chat_rating_${t.id}`);
    const div=document.createElement('div');
    div.className='ticket-card';
    div.innerHTML=`
      <h4>${t.subject}</h4>
      <p>${t.message}</p>
      ${t.images.length?`<div class="ticket-images">${t.images.map(img=>`<img src="${img}" onclick="openImage('${img}')">`).join('')}</div>`:''}
      <p><strong>Status:</strong> ${t.status}</p>
      ${rating?`<p>‚≠ê Rated: ${rating}/5</p>`:''}
      <button class="ticket-chat-btn" onclick="openChat('${t.id}')">üí¨ Contact Agent</button>
    `;
    ticketsList.appendChild(div);
  });
}

// Ticket submission
form.addEventListener('submit',async e=>{
  e.preventDefault();
  const imgs=await readFiles(document.getElementById('images').files);
  const tickets=JSON.parse(localStorage.getItem('tickets')||'[]');
  const ticket={
    id:Date.now(),
    name:form.name.value,
    email:form.email.value,
    subject:form.subject.value,
    message:form.message.value,
    images:imgs,
    status:'pending'
  };
  tickets.push(ticket);
  localStorage.setItem('tickets',JSON.stringify(tickets));
  form.reset();
  renderTickets();
  alert('Ticket submitted successfully!');
});

// Chat logic
const chatModal=document.getElementById('chat-modal');
const chatBox=document.getElementById('chat-box');
const chatInput=document.getElementById('chat-input');
const chatFiles=document.getElementById('chat-files');
const sendChatBtn=document.getElementById('send-chat');
const downloadChatBtn=document.getElementById('download-chat');
const endChatBtn=document.getElementById('end-chat');

function renderChat(){
  if(!currentTicket)return;
  const history=JSON.parse(localStorage.getItem(`live_chat_${currentTicket}`)||'[]');
  chatBox.innerHTML='';
  history.forEach(m=>{
    let content='';
    if(m.text) content+=`<span style="background:${m.sender==='customer'?'var(--gradient)':'#444'};padding:0.5rem;border-radius:12px;color:white;display:inline-block;max-width:70%;">${m.text}</span>`;
    if(m.images) content+=m.images.map(img=>`<br><img src="${img}" onclick="openImage('${img}')" style="max-width:80px;max-height:80px;border-radius:8px;margin-top:0.3rem;">`).join('');
    const div=document.createElement('div');
    div.style.textAlign=m.sender==='customer'?'right':'left';
    div.style.margin='0.3rem 0';
    div.innerHTML=content;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

async function addChatMessage(){
  if(!currentTicket)return;
  const text=chatInput.value.trim();
  if(!text&&!chatFiles.files.length)return;
  const imgs=await readFiles(chatFiles.files);
  const key=`live_chat_${currentTicket}`;
  const chat=JSON.parse(localStorage.getItem(key)||'[]');
  chat.push({sender:'customer',text,images:imgs,time:Date.now()});
  localStorage.setItem(key,JSON.stringify(chat));
  chatInput.value=''; chatFiles.value='';
  renderChat();
}

sendChatBtn.onclick=addChatMessage;

function openChat(id){
  currentTicket=id;
  chatModal.style.display='flex';
  renderChat();
}

downloadChatBtn.onclick=()=>{
  if(!currentTicket)return;
  const chat=JSON.parse(localStorage.getItem(`live_chat_${currentTicket}`)||'[]');
  let content='=== Chat History ===\n';
  chat.forEach(m=>{
    content+=`${m.sender==='customer'?'You':'Agent'}: ${m.text||''}\n`;
    if(m.images)m.images.forEach((_,i)=>content+=`[Image ${i+1}]\n`);
  });
  const blob=new Blob([content],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`chat_${Date.now()}.txt`;
  a.click();
};

// End Chat + Rating
const ratingModal=document.getElementById('rating-modal');
const stars=document.querySelectorAll('.star');
const thankYou=document.getElementById('thank-you');
const feedback=document.getElementById('feedback');

endChatBtn.onclick=()=>{
  chatModal.style.display='none';
  ratingModal.style.display='flex';
};

stars.forEach(star=>{
  star.addEventListener('click',()=>{
    const val=parseInt(star.dataset.value);
    stars.forEach(s=>s.classList.remove('selected'));
    for(let i=0;i<val;i++)stars[i].classList.add('selected');

    if(currentTicket){
      localStorage.setItem(`chat_rating_${currentTicket}`,val);
      localStorage.setItem(`chat_status_${currentTicket}`,'ended'); // notify admin instantly
      const tickets=JSON.parse(localStorage.getItem('tickets')||'[]');
      const t=tickets.find(x=>x.id==currentTicket);
      const review={
        ticketId:currentTicket,
        name:t?.name||'Anonymous',
        rating:val,
        feedback:feedback.value.trim()||'No comment provided',
        date:Date.now()
      };
      localStorage.setItem(`chat_review_${currentTicket}`,JSON.stringify(review));
    }

    thankYou.style.display='block';
    setTimeout(()=>{
      ratingModal.style.display='none';
      thankYou.style.display='none';
      feedback.value='';
      stars.forEach(s=>s.classList.remove('selected'));
      renderTickets();
    },2000);
  });
});

setInterval(()=>{renderTickets();renderChat();},1000);
</script>
<!-- üîî Global Order Notifications -->
<script src="admin-notify.js"></script>
</body>
</html>
