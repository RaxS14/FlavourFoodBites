<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shopping Cart - Flavour Food Bites</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
/* ===== SAME DESIGN (UNTOUCHED) ===== */
:root {
  --primary:#FF6B35; --secondary:#2C3E50; --bg:#0F0F23; --bg-light:#1a1a3a;
  --text:#fff; --text-secondary:#B8BCC8; --glass: rgba(255,255,255,0.1);
  --glass-border: rgba(255,255,255,0.2);
  --gradient-primary: linear-gradient(135deg,#FF6B35 0%,#E55A2B 50%,#FF8A50 100%);
  --gradient-secondary: linear-gradient(135deg,#3498DB 0%,#2980B9 100%);
}
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;}
body::before {
  content:'';position:fixed;top:0;left:0;width:100%;height:100%;
  background: radial-gradient(circle at 20% 80%, rgba(255,107,53,0.15) 0%, transparent 50%),
              radial-gradient(circle at 80% 20%, rgba(52,152,219,0.15) 0%, transparent 50%),
              radial-gradient(circle at 40% 40%, rgba(39,174,96,0.1) 0%, transparent 50%),
              linear-gradient(135deg,#0F0F23 0%,#1a1a3a 100%);
  z-index:-2;
}
header {position:fixed;top:0;left:0;right:0;background:rgba(15,15,35,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-border);z-index:1000;}
.navbar {display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;max-width:1400px;margin:0 auto;}
.logo-section {display:flex;align-items:center;gap:1rem;}
.logo {width:60px;height:60px;background:var(--gradient-primary);border-radius:16px;display:flex;justify-content:center;align-items:center;color:#fff;font-size:1.8rem;font-weight:bold;box-shadow:0 0 40px rgba(255,107,53,0.3);}
.brand-name {font-size:1.8rem;font-weight:800;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-1px;}
.nav-links {display:flex;list-style:none;gap:2rem;}
.nav-links a {text-decoration:none;color:var(--text-secondary);font-weight:600;padding:0.75rem 1.5rem;border-radius:12px;transition:0.3s;}
.nav-links a:hover,.nav-links a.active {color:var(--text);transform:translateY(-2px);}
.cart-container {max-width:1200px;margin:0 auto;padding:120px 2rem 4rem;display:grid;grid-template-columns:2fr 1fr;gap:3rem;}
.cart-header {grid-column:1/-1;text-align:center;margin-bottom:3rem;}
.cart-title {font-size:clamp(2.5rem,5vw,4rem);font-weight:900;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.5rem;letter-spacing:-2px;}
.cart-subtitle {font-size:1.2rem;color:var(--text-secondary);}
.cart-items-section,.cart-summary-section {background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:24px;padding:2rem;height:fit-content;}
.cart-items {display:flex;flex-direction:column;gap:1.5rem;}
.cart-item {background:var(--bg-light);border:1px solid var(--glass-border);border-radius:16px;padding:1.5rem;transition:0.3s;}
.cart-item:hover {transform:translateX(8px);border-color:var(--primary);box-shadow:0 10px 30px rgba(255,107,53,0.2);}
.item-header {display:flex;justify-content:space-between;margin-bottom:1rem;}
.item-info h3 {font-size:1.3rem;font-weight:700;color:var(--text);margin-bottom:0.5rem;}
.item-info p {color:var(--text-secondary);font-size:0.9rem;}
.item-price {font-size:1.5rem;font-weight:800;color:var(--primary);}
.item-controls {display:flex;justify-content:space-between;align-items:center;margin-top:1rem;}
.quantity-controls {display:flex;align-items:center;background:var(--glass);border-radius:50px;padding:0.5rem;border:1px solid var(--glass-border);}
.quantity-btn {width:40px;height:40px;border:none;background:var(--glass);color:var(--text);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:1.2rem;transition:0.3s;}
.quantity-btn:hover {background:var(--primary);transform:scale(1.1);}
.quantity-display {min-width:60px;text-align:center;font-weight:700;font-size:1.2rem;color:var(--text);}
.remove-btn {background:#E74C3C;color:#fff;border:none;padding:0.75rem 1.5rem;border-radius:50px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:0.5rem;transition:0.3s;}
.remove-btn:hover {transform:translateY(-2px);box-shadow:0 10px 30px rgba(231,76,60,0.4);}
.summary-item {display:flex;justify-content:space-between;padding:1rem 0;border-bottom:1px solid var(--glass-border);}
.summary-item:last-child {border:none;font-size:1.5rem;font-weight:800;color:var(--primary);padding-top:1.5rem;margin-top:1rem;border-top:2px solid var(--glass-border);}
.summary-label {font-weight:600;color:var(--text-secondary);}
.summary-value {font-weight:700;color:var(--text);}
.checkout-btn,.location-btn {width:100%;border:none;padding:1.25rem;border-radius:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.75rem;transition:0.3s;}
.location-btn {background:var(--gradient-secondary);color:#fff;margin-top:1rem;}
.checkout-btn {background:var(--gradient-primary);color:#fff;margin-top:1rem;font-size:1.2rem;}
.modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;}
.modal .modal-content {background:#1a1a3a;padding:2rem;border-radius:24px;max-width:500px;width:90%;text-align:center;color:#fff;position:relative;}
.modal .close-btn {position:absolute;top:1rem;right:1.5rem;font-size:1.5rem;cursor:pointer;}
#map {width:100%;height:400px;border-radius:16px;margin-top:1rem;}
#selected-location {margin-top:1rem;font-size:1rem;color:#B8BCC8;}
#gcash-preview img {width:80px;height:80px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,107,53,0.3);}
</style>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="logo-section">
      <div class="logo"><i class="fas fa-utensils"></i></div>
      <span class="brand-name">Flavour Food Bites</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="menu.html">Menu</a></li>
      <li><a href="lcart.html" class="active">Cart</a></li>
      <li><a href="orders.html">Orders</a></li>
      <li><a href="reviews.html">Reviews</a></li>
      <li><a href="aboutus.html">About Us</a></li>
      <li><a href="customerService.html">Customer Service</a></li>
      <li><a href="login.html">Logout</a></li>
    </ul>
  </nav>
</header>

<main class="cart-container">
  <div class="cart-header">
    <h1 class="cart-title">Your Cart</h1>
    <p class="cart-subtitle">Review your items and proceed to checkout</p>
  </div>

  <section class="cart-items-section">
    <h2 class="section-title"><i class="fa-solid fa-bag-shopping"></i> Cart Items</h2>
    <div class="cart-items"></div>
  </section>

  <section class="cart-summary-section">
    <h2 class="section-title"><i class="fa-solid fa-list-check"></i> Order Summary</h2>
    <div class="summary-item"><span class="summary-label">Subtotal</span><span id="subtotal" class="summary-value">â‚±0.00</span></div>
    <div class="summary-item"><span class="summary-label">Delivery Fee</span><span id="delivery" class="summary-value">â‚±30.00</span></div>
    <div class="summary-item"><span class="summary-label">Total</span><span id="total" class="summary-value">â‚±0.00</span></div>
    <button id="select-location" class="location-btn"><i class="fa-solid fa-location-dot"></i> Select Delivery Location</button>
    <button id="checkout-btn" class="checkout-btn"><i class="fa-solid fa-credit-card"></i> Proceed to Checkout</button>
  </section>
</main>

<!-- === DELIVERY & CHECKOUT MODALS (UNCHANGED) === -->
<div id="delivery-modal" class="modal">
  <div class="modal-content">
    <span id="close-location" class="close-btn">&times;</span>
    <h2>Select Delivery Location</h2>
    <div id="map"></div>
    <div id="selected-location">Selected: None</div>
    <button id="confirm-location" style="margin-top:1rem;">Confirm Location</button>
  </div>
</div>

<div id="checkout-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Checkout</h2>
    <div style="margin-bottom:1rem;text-align:left;">
      <label for="customer-name">Full Name</label>
      <input id="customer-name" type="text" placeholder="Enter your full name" style="width:100%;padding:0.75rem;border-radius:8px;border:1px solid #555;background:#1a1a3a;color:#fff;">
    </div>
    <div style="margin-bottom:1rem;text-align:left;">
      <label for="customer-contact">Contact Number</label>
      <input id="customer-contact" type="text" placeholder="Enter your contact number" style="width:100%;padding:0.75rem;border-radius:8px;border:1px solid #555;background:#1a1a3a;color:#fff;">
    </div>
    <select id="modal-payment-method">
      <option value="">Select Payment Method</option>
      <option value="COD">Cash on Delivery (COD)</option>
      <option value="GCash">GCash</option>
    </select>
    <div id="gcash-info" style="display:none;margin-top:1rem;text-align:left;">
      <h3 style="color:#FF6B35;">Pay to Seller</h3>
      <p><strong>Name:</strong> Raxcel L.</p>
      <p><strong>Number:</strong> 09560351994</p>
      <p style="color:#B8BCC8;margin-top:0.5rem;">Scan the QR code below to pay via GCash</p>
      <img src="images/gcash-qr.jpg" alt="GCash QR Code"
     style="width:200px;height:auto;display:block;margin:1rem auto;
     border-radius:12px;box-shadow:0 0 20px rgba(255,107,53,0.3);">
      <p style="margin-top:1rem;">Upload Receipt (1â€“2 images)</p>
      <input id="gcash-receipt" type="file" accept="image/*" multiple>
      <div id="gcash-preview" style="display:flex;gap:10px;margin-top:0.5rem;"></div>
    </div>
    <button id="confirm-checkout" style="margin-top:1rem;">Confirm Order</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// === FIXED PRICING & NORMALIZATION LOGIC ===
// Keeps design intact, only fixes price/quantity handling so values always display.

const DELIVERY_FEE = 30;
const BUSINESS = { lat: 10.2583, lng: 123.8167 };

let cart = JSON.parse(localStorage.getItem('cart')) || [];
const cartContainer = document.querySelector('.cart-items');
const summarySection = document.querySelector('.cart-summary-section');

// Convert various possible incoming shapes to a normalized item:
// - ensure price is a number
// - ensure qty exists (from qty or quantity) and is a number >= 1
function normalizeCartItems(rawCart) {
  return (rawCart || []).map(item => {
    const normalized = Object.assign({}, item);
    // normalize price
    normalized.price = (() => {
      // handle strings like "100", "â‚±100.00", null, undefined
      if (typeof item.price === 'number') return item.price;
      if (typeof item.price === 'string') {
        // strip non-numeric (except decimal point and minus)
        const cleaned = item.price.replace(/[^0-9.\-]+/g, '');
        const n = parseFloat(cleaned);
        return isNaN(n) ? 0 : n;
      }
      return 0;
    })();

    // normalize quantity (support both qty and quantity)
    const rawQty = item.qty ?? item.quantity ?? item.count ?? 1;
    const parsedQty = parseInt(rawQty, 10);
    normalized.qty = (isNaN(parsedQty) || parsedQty < 1) ? 1 : parsedQty;

    return normalized;
  });
}

// Helper to safely parse numbers
function toNumber(v) {
  const n = Number(v);
  return (typeof n === 'number' && !isNaN(n)) ? n : 0;
}

// Save cart (always saving normalized representation)
function saveCart() {
  localStorage.setItem('cart', JSON.stringify(cart));
}

// Update subtotal, delivery, total
function updateSummary() {
  const subtotal = cart.reduce((sum, item) => sum + toNumber(item.price) * toNumber(item.qty), 0);
  const total = subtotal + DELIVERY_FEE;
  document.getElementById('subtotal').textContent = `â‚±${subtotal.toFixed(2)}`;
  document.getElementById('delivery').textContent = `â‚±${DELIVERY_FEE.toFixed(2)}`;
  document.getElementById('total').textContent = `â‚±${total.toFixed(2)}`;
}

function removeItem(id) {
  const removedItem = cart.find(i => i.id === id);
  cart = cart.filter(i => i.id !== id);
  localStorage.setItem('cart', JSON.stringify(cart));

  // === Restore stock and fix pending count ===
  const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
  const product = inventory.find(p => p.id === id);
  if (product && removedItem) {
    const qty = Number(removedItem.quantity) || 1;
    product.stock = (Number(product.stock) || 0) + qty;
    product.pending = Math.max((Number(product.pending) || 0) - qty, 0);
    localStorage.setItem('inventory', JSON.stringify(inventory));
  }

  renderCart();
}

// Find index helper (by id)
function findIndexById(id) {
  return cart.findIndex(it => it.id === id);
}

// Render cart UI
function renderCart() {
  cartContainer.innerHTML = '';
  // ensure cart is an array
  if (!Array.isArray(cart) || cart.length === 0) {
    summarySection.style.display = 'none';
    cartContainer.innerHTML = `
      <div class="empty-cart">
        <i class="fas fa-cart-shopping empty-icon"></i>
        <div class="empty-title">Your cart is empty</div>
        <div class="empty-description">Add some delicious meals to your cart!</div>
        <a href="menu.html" class="continue-shopping"><i class="fas fa-utensils"></i> Continue Shopping</a>
      </div>`;
    document.getElementById('subtotal').textContent = 'â‚±0.00';
    document.getElementById('delivery').textContent = `â‚±${DELIVERY_FEE.toFixed(2)}`;
    document.getElementById('total').textContent = 'â‚±0.00';
    return;
  }

  summarySection.style.display = 'block';

  cart.forEach((item, idx) => {
    const itemPrice = toNumber(item.price);
    const itemQty = Math.max(1, parseInt(item.qty, 10) || 1);
    const lineTotal = itemPrice * itemQty;

    const el = document.createElement('div');
    el.className = 'cart-item';
    el.dataset.id = item.id;

    el.innerHTML = `
      <div class="item-header">
        <div class="item-info">
          <h3>${escapeHtml(item.name || 'Unnamed item')}</h3>
          <p>${itemQty}x</p>
        </div>
        <div class="item-price">â‚±${lineTotal.toFixed(2)}</div>
      </div>
      <div class="item-controls">
        <div class="quantity-controls">
          <button class="quantity-btn minus">-</button>
          <div class="quantity-display">${itemQty}</div>
          <button class="quantity-btn plus">+</button>
        </div>
        <button class="remove-btn"><i class="fa-solid fa-trash"></i> Remove</button>
      </div>`;

// minus handler
const minusBtn = el.querySelector('.minus');
minusBtn.addEventListener('click', () => {
  const i = findIndexById(item.id);
  if (i === -1) return;

  const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
  const product = inventory.find(p => p.id === item.id);

  if (product && cart[i].qty > 1) {
    cart[i].qty = Number(cart[i].qty) - 1;
    product.stock++;
    product.pending = Math.max((Number(product.pending) || 0) - 1, 0);
  } else {
    // remove if quantity hits 0
    if (product) {
      product.stock += Number(cart[i].qty);
      product.pending = Math.max((Number(product.pending) || 0) - Number(cart[i].qty), 0);
    }
    cart.splice(i, 1);
  }

  localStorage.setItem('inventory', JSON.stringify(inventory));
  saveCart();
  renderCart();
  window.dispatchEvent(new Event("storage")); // ðŸ”” Notify menu.html instantly
});

// plus handler
const plusBtn = el.querySelector('.plus');
plusBtn.addEventListener('click', () => {
  const i = findIndexById(item.id);
  if (i === -1) return;

  const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
  const product = inventory.find(p => p.id === item.id);

  if (product && product.stock > 0) {
    cart[i].qty = Number(cart[i].qty) + 1;
    product.stock--;
    product.pending = (Number(product.pending) || 0) + 1;
    localStorage.setItem('inventory', JSON.stringify(inventory));
    saveCart();
    renderCart();
    window.dispatchEvent(new Event("storage")); // ðŸ”” Notify menu.html instantly
  } else {
    alert('No more stock available!');
  }
});

    // remove handler
    el.querySelector('.remove-btn').addEventListener('click', () => {
      removeItem(item.id);
    });

    cartContainer.appendChild(el);
  });

  updateSummary();
}

// small helper to avoid XSS for names (keeps design identical)
function escapeHtml(str) {
  if (!str && str !== 0) return '';
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// ----------------- Initialization -----------------
// Normalize cart once on load, then render
(function initCart() {
  cart = normalizeCartItems(cart);
  saveCart();
  renderCart();
})();

// ----------------- Delivery modal and Checkout logic (kept intact) -----------------
let map, marker, selectedCoords = null;
document.getElementById('select-location').addEventListener('click', () => {
  const modal = document.getElementById('delivery-modal');
  modal.style.display = 'flex';
  if (!map) {
    map = L.map('map').setView([BUSINESS.lat, BUSINESS.lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([BUSINESS.lat, BUSINESS.lng], { draggable: true }).addTo(map);
    marker.bindPopup("<b>Flavour Food Bites</b>").openPopup();
    marker.on('dragend', e => {
      selectedCoords = e.target.getLatLng();
      document.getElementById('selected-location').textContent = `Selected: ${selectedCoords.lat.toFixed(6)}, ${selectedCoords.lng.toFixed(6)}`;
    });
    selectedCoords = marker.getLatLng();
    document.getElementById('selected-location').textContent = `Selected: ${selectedCoords.lat.toFixed(6)}, ${selectedCoords.lng.toFixed(6)}`;
  }
});
document.getElementById('close-location').addEventListener('click', () => {
  document.getElementById('delivery-modal').style.display = 'none';
});
document.getElementById('confirm-location').addEventListener('click', () => {
  if (!selectedCoords) return alert('Please select a location');
  localStorage.setItem('deliveryLocation', JSON.stringify({ lat: selectedCoords.lat, lng: selectedCoords.lng }));
  alert(`Delivery location set to: ${selectedCoords.lat.toFixed(6)}, ${selectedCoords.lng.toFixed(6)}`);
  document.getElementById('delivery-modal').style.display = 'none';
});

// Checkout modal
const checkoutModal = document.getElementById('checkout-modal');
document.getElementById('checkout-btn').addEventListener('click', () => {
  if (!cart.length) return alert('Cart is empty!');
  checkoutModal.style.display = 'flex';
});
checkoutModal.querySelector('.close-btn').addEventListener('click', () => checkoutModal.style.display = 'none');

document.getElementById('modal-payment-method').addEventListener('change', (e) => {
  document.getElementById('gcash-info').style.display = e.target.value === 'GCash' ? 'block' : 'none';
});

document.getElementById('gcash-receipt').addEventListener('change', (e) => {
  const preview = document.getElementById('gcash-preview');
  preview.innerHTML = '';
  Array.from(e.target.files).slice(0,2).forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

document.getElementById('confirm-checkout').addEventListener('click', () => {
  const name = document.getElementById('customer-name').value.trim();
  const contact = document.getElementById('customer-contact').value.trim();
  const method = document.getElementById('modal-payment-method').value;
  if (!name) return alert('Please enter your full name');
  if (!contact) return alert('Please enter your contact number');
  if (!method) return alert('Please select a payment method');
  if (method === 'GCash' && document.getElementById('gcash-receipt').files.length < 1) return alert('Please upload at least 1 GCash receipt!');
  // finalize order
  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
  const subtotal = cart.reduce((s, it) => s + toNumber(it.price) * toNumber(it.qty), 0);
  const order = {
    id: Date.now(),
    items: cart,
    subtotal,
    deliveryFee: DELIVERY_FEE,
    total: subtotal + DELIVERY_FEE,
    paymentMethod: method,
    location: JSON.parse(localStorage.getItem('deliveryLocation') || JSON.stringify(BUSINESS)),
    date: new Date().toISOString(),
    status: 'pending',
    customerName: name,
    customerContact: contact
  };
  orders.push(order);
  localStorage.setItem('orders', JSON.stringify(orders));
  // clear cart and update UI
  cart = [];
  saveCart();
  renderCart();
  checkoutModal.style.display = 'none';
  // optionally redirect to orders page
  window.location.href = 'orders.html';
});
</script>
</body>
</html>
