<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reports — Flavour Food Bites Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0F0F23; --card:#1a1a3a; --accent:#FF6B35; --muted:#bfc3ce; --success:#27ae60;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Poppins',sans-serif;
    background:linear-gradient(180deg,#07071a 0%,#0f0f23 100%);
    color:#fff; display:flex; min-height:100vh;
  }

  /* Sidebar (same look & placement as your other admin pages) */
  .sidebar{
    width:260px; background:var(--card); padding:2rem 1rem; position:fixed; height:100%; box-shadow:2px 0 15px rgba(0,0,0,.2);
  }
  .sidebar img{ width:72px; height:72px; border-radius:50%; object-fit:cover }
  .sidebar h2{ color:var(--accent); margin-top:.6rem; font-size:1.15rem }
  .sidebar p{ color:var(--muted); font-size:.85rem; margin-bottom:1.2rem }
  .sidebar .nav{ list-style:none; margin-top:1rem }
  .sidebar .nav a{ display:block; color:#fff; text-decoration:none; padding:.6rem .8rem; border-radius:8px; margin:.25rem 0 }
  .sidebar .nav a.active, .sidebar .nav a:hover{ background:var(--accent); color:#fff; }

  /* Main */
  main{ margin-left:260px; padding:2rem; flex:1; overflow:auto; min-height:100vh }
  header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:1.25rem }
  header h1{ font-size:1.4rem; color:var(--accent) }
  header .controls{ display:flex; gap:.5rem; align-items:center }

  /* Summary cards */
  .summary { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-bottom:1.25rem }
  .card {
    background:var(--card); border-radius:14px; padding:1rem; box-shadow:0 10px 25px rgba(255,107,53,0.06);
  }
  .card h3{ font-size:1.25rem; color:var(--muted); font-weight:600; margin-bottom:.4rem }
  .card .value{ font-size:1.5rem; font-weight:800; margin-top:.25rem; color:#fff }

  /* Layout for charts */
  .grid { display:grid; grid-template-columns: 1fr 420px; gap:1rem; align-items:start }
  .panel { background:var(--card); border-radius:14px; padding:1rem }
  .panel h2{ color:var(--accent); font-size:1.05rem; margin-bottom:.6rem }

  /* low stock list */
  .low-list { display:flex; flex-direction:column; gap:.6rem }
  .low-item { display:flex; justify-content:space-between; align-items:center; padding:.45rem .6rem; border-radius:8px; background:rgba(255,255,255,0.02) }
  .low-item.warn{ box-shadow:0 6px 20px rgba(255,107,53,0.08); border-left:4px solid #ff8a50 }
  .low-item .name{ font-weight:600 }
  .low-item .stock{ color:var(--muted) }

  /* small UI */
  button, .btn {
    background:var(--accent); border:none; color:#fff; padding:.5rem .8rem; border-radius:8px; cursor:pointer;
  }
  .muted{ color:var(--muted); font-size:.9rem }
  footer{ margin-top:1.25rem; color:var(--muted); font-size:.85rem }

  @media(max-width:980px){
    .grid{ grid-template-columns: 1fr; }
    main{ padding:1rem }
  }
</style>
</head>
<body>

<aside class="sidebar">
  <img src="images/admin-avatar.png" alt="Admin">
  <h2>Admin</h2>
  <p>Flavour Food Bites</p>
  <ul class="nav">
    <li><a href="admin.html">Dashboard</a></li>
    <li><a href="adminorder.html">Orders</a></li>
    <li><a href="inventory.html">Inventory</a></li>
    <li><a href="suppliers.html"><i class="ri-truck-line"></i> Suppliers</a></li>
    <li><a href="reports.html" class="active">Reports</a></li>
    <li><a href="login.html">Logout</a></li>
  </ul>
</aside>

<main>
  <header>
    <h1>Reports</h1>
    <div class="controls">
      <button id="exportCsv">Export Orders CSV</button>
      <div class="muted" id="lastUpdated">—</div>
    </div>
  </header>

  <section class="summary" id="summary">
    <div class="card">
      <h3>Total Sales (₱)</h3>
      <div class="value" id="totalSales">₱0.00</div>
      <div class="muted" id="salesPeriod">Last 7 days</div>
    </div>
    <div class="card">
      <h3>Total Orders</h3>
      <div class="value" id="totalOrders">0</div>
      <div class="muted">All statuses</div>
    </div>
    <div class="card">
      <h3>Completed / Delivered</h3>
      <div class="value" id="completedOrders">0</div>
      <div class="muted">Orders marked delivered/completed</div>
    </div>
    <div class="card">
      <h3>Cancelled</h3>
      <div class="value" id="cancelledOrders">0</div>
      <div class="muted">Customer/admin cancellations</div>
    </div>
  </section>

  <div class="grid">
    <div class="panel">
      <h2>Sales (last 7 days)</h2>
      <canvas id="salesChart" height="220"></canvas>
      <hr style="opacity:.06;margin:12px 0">
      <h2 style="margin-top:8px">Top-selling products</h2>
      <canvas id="topChart" height="200"></canvas>
    </div>

    <div class="panel">
      <h2>Low-stock inventory</h2>
      <div id="lowStock" class="low-list"></div>

      <hr style="opacity:.06;margin:12px 0">
      <h2>Quick actions</h2>
      <div style="display:flex;flex-direction:column;gap:.6rem">
        <button id="refreshBtn" class="btn">Refresh now</button>
        <button id="clearCache" class="btn" style="background:#b74a3f">Clear All Orders (Danger)</button>
        <div class="muted" style="margin-top:.6rem">Low stock threshold: ≤ <input id="threshold" type="number" value="5" style="width:60px;padding:.25rem;border-radius:6px;background:#0f0f23;color:#fff;border:1px solid rgba(255,255,255,0.04)"> </div>
      </div>
    </div>
  </div>

  <footer>
    Reports read directly from <strong>localStorage</strong> keys: <code>"orders"</code> and <code>"inventory"</code>. Updates automatically.
  </footer>
</main>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/*
  Reports page - reads orders & inventory from localStorage
  Expected formats (best setup):
  orders -> array of {
    id: "ORD123",
    date: "2025-10-24T14:23:00Z",
    items: [{ name:"Burger", price:120, quantity:2 }, ...],
    total: 320,
    status: "delivered" // or "cancelled","pending","preparing"
  }

  inventory -> array of {
    name: "Burger",
    stock: 15,
    price: 120,
    status: "available"
  }
*/

const ctxSales = document.getElementById('salesChart').getContext('2d');
const ctxTop = document.getElementById('topChart').getContext('2d');

let salesChart = null;
let topChart = null;

const selectors = {
  totalSales: document.getElementById('totalSales'),
  totalOrders: document.getElementById('totalOrders'),
  completedOrders: document.getElementById('completedOrders'),
  cancelledOrders: document.getElementById('cancelledOrders'),
  lowStock: document.getElementById('lowStock'),
  lastUpdated: document.getElementById('lastUpdated'),
  thresholdInput: document.getElementById('threshold'),
};

// helper - safe parse
function getLocal(key){
  try{
    return JSON.parse(localStorage.getItem(key) || '[]');
  } catch(e) { return [] }
}

function isCompleted(status){
  if(!status) return false;
  const s = status.toString().toLowerCase();
  return s==='delivered' || s==='completed' || s==='done';
}

function isCancelled(status){
  if(!status) return false;
  const s = status.toString().toLowerCase();
  return s==='cancelled' || s==='rejected';
}

function getLastNDates(n){
  const arr=[];
  const today = new Date();
  for(let i=n-1;i>=0;i--){
    const d = new Date(today);
    d.setDate(today.getDate()-i);
    arr.push(d);
  }
  return arr;
}

function dateKey(d){
  return d.toISOString().slice(0,10); // YYYY-MM-DD
}

function buildReports(){
  const orders = getLocal('orders') || [];
  const inventory = getLocal('inventory') || [];

  // summary numbers
  const totalOrders = orders.length;
  const completed = orders.filter(o=>isCompleted(o.status)).length;
  const cancelled = orders.filter(o=>isCancelled(o.status)).length;

  // total sales — include only completed / delivered orders
  const totalSalesAmt = orders.filter(o=>isCompleted(o.status)).reduce((s,o)=> s + (Number(o.total)||0), 0);

  // Sales by day (last 7 days)
  const days = getLastNDates(7); // array of Date
  const dayKeys = days.map(d=>dateKey(d));
  const salesByDay = Object.fromEntries(dayKeys.map(k=>[k,0]));

  orders.forEach(o=>{
    if(!o.date) return;
    const dkey = dateKey(new Date(o.date));
    if(!(dkey in salesByDay)) return;
    if(isCompleted(o.status)) salesByDay[dkey] += Number(o.total)||0;
  });

  // top selling products (by quantity) across completed orders
  const productMap = new Map();
  orders.filter(o=>isCompleted(o.status)).forEach(o=>{
    (o.items||[]).forEach(it=>{
      const name = (it.name||'Unknown').toString();
      const qty = Number(it.quantity || it.qty || it.quantityOrdered || it.qtyOrdered || 0) || Number(it.qty || it.quantity || 0) || 0;
      const price = Number(it.price||0) || 0;
      const current = productMap.get(name) || { qty:0, revenue:0, price };
      current.qty += qty;
      current.revenue += qty * price;
      productMap.set(name,current);
    });
  });

  const topProducts = Array.from(productMap.entries()).map(([name, data])=>({ name, qty: data.qty, revenue: data.revenue }))
    .sort((a,b)=> b.qty - a.qty)
    .slice(0,8);

  // low stock from inventory
  const threshold = Number(document.getElementById('threshold').value) || 5;
  const lowItems = (inventory || []).map(it=>{
    return {
      name: it.name || it.item || 'Unknown',
      stock: Number(it.stock || it.qty || it.quantity || 0),
      price: Number(it.price || 0),
      status: it.status || ''
    };
  }).filter(i=>i.stock <= threshold)
    .sort((a,b)=> a.stock - b.stock);

  // Update DOM
  selectors.totalSales.textContent = `₱${totalSalesAmt.toFixed(2)}`;
  selectors.totalOrders.textContent = `${totalOrders}`;
  selectors.completedOrders.textContent = `${completed}`;
  selectors.cancelledOrders.textContent = `${cancelled}`;
  selectors.lastUpdated.textContent = 'Updated: ' + (new Date()).toLocaleString();

  // render low stock list
  selectors.lowStock.innerHTML = '';
  if(lowItems.length===0){
    selectors.lowStock.innerHTML = '<div class="muted">No low-stock items (within threshold)</div>';
  } else {
    lowItems.forEach(it=>{
      const el = document.createElement('div');
      el.className = 'low-item warn';
      el.innerHTML = `<div class="name">${it.name}</div><div class="stock">Stock: ${it.stock}</div>`;
      selectors.lowStock.appendChild(el);
    });
  }

  // Draw charts
  const salesData = dayKeys.map(k=> salesByDay[k] || 0 );
  // Sales chart
  if(salesChart) salesChart.destroy();
  salesChart = new Chart(ctxSales, {
    type: 'line',
    data: {
      labels: dayKeys.map(k=> new Date(k).toLocaleDateString()),
      datasets: [{
        label: 'Sales (₱)',
        data: salesData,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 4,
        fill: true,
        backgroundColor: 'rgba(255,107,53,0.12)',
        borderColor: 'rgba(255,107,53,1)'
      }]
    },
    options: {
      responsive:true,
      plugins: { legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } }
    }
  });

  // Top products chart
  const topLabels = topProducts.map(t=>t.name);
  const topQtys = topProducts.map(t=>t.qty);
  if(topChart) topChart.destroy();
  topChart = new Chart(ctxTop, {
    type: 'bar',
    data: {
      labels: topLabels,
      datasets: [{
        label: 'Qty sold',
        data: topQtys,
        borderRadius:6,
        barThickness: 28,
        backgroundColor: 'rgba(52,152,219,0.85)'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{ x:{ beginAtZero:true } }
    }
  });
}

// Export orders to CSV
function exportOrdersCSV(){
  const orders = getLocal('orders') || [];
  if(!orders || orders.length===0){ alert('No orders to export'); return; }

  // Build CSV: basic flattening
  const rows = [];
  rows.push(['id','date','status','total','item_names','item_quantities','item_prices'].join(','));
  orders.forEach(o=>{
    const itemNames = (o.items||[]).map(it=>`"${(it.name||'').toString().replace(/"/g,'""')}"`).join('|');
    const itemQtys = (o.items||[]).map(it=> (it.quantity||it.qty||0) ).join('|');
    const itemPrices = (o.items||[]).map(it=> (it.price||0) ).join('|');
    const line = [
      `"${(o.id||'').toString().replace(/"/g,'""')}"`,
      `"${(o.date||'').toString().replace(/"/g,'""')}"`,
      `"${(o.status||'').toString().replace(/"/g,'""')}"`,
      (Number(o.total)||0),
      `"${itemNames}"`,
      `"${itemQtys}"`,
      `"${itemPrices}"`
    ].join(',');
    rows.push(line);
  });

  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `orders_${(new Date()).toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// initial draw
buildReports();

// live update: poll + storage event (covers single-tab local changes too)
let lastJSON = JSON.stringify({ orders: localStorage.getItem('orders'), inventory: localStorage.getItem('inventory') });
setInterval(()=>{
  const currentJSON = JSON.stringify({ orders: localStorage.getItem('orders'), inventory: localStorage.getItem('inventory') });
  if(currentJSON !== lastJSON){
    lastJSON = currentJSON;
    try{ buildReports(); } catch(e){ console.error(e) }
  }
},1000);

window.addEventListener('storage', (e)=>{
  if(e.key==='orders' || e.key==='inventory'){
    buildReports();
  }
});

// UI hooks
document.getElementById('exportCsv').addEventListener('click', exportOrdersCSV);
document.getElementById('refreshBtn').addEventListener('click', ()=> buildReports());
document.getElementById('clearCache').addEventListener('click', ()=>{
  if(confirm('This will remove ALL orders from localStorage. Are you sure?')){
    localStorage.removeItem('orders');
    buildReports();
  }
});
document.getElementById('threshold').addEventListener('change', buildReports);
</script>

</body>
</html>
