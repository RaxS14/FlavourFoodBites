<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Track Delivery - Flavour Food Bites</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: #0F0F23;
    color: #fff;
  }
  #map { width: 100vw; height: 100vh; }
  .motorcycle-emoji { font-size: 30px; }
  .back-btn {
    position: absolute;
    top: 15px; left: 15px;
    z-index: 1000;
    background: #FF6B35;
    border: none;
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
  }
</style>
</head>
<body>

<button class="back-btn" onclick="history.back()">‚Üê Back</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjA5MDUyYzIyYzc4NDRhMTBiZjE3M2I1NGRlYmFmMTNiIiwiaCI6Im11cm11cjY0In0=';

// --- Business + delivery coordinates ---
const BUSINESS = { lat: 10.2583, lng: 123.8167 };
const savedDelivery = JSON.parse(localStorage.getItem('deliveryLocation'));
const DELIVERY = savedDelivery || { lat: 10.2600, lng: 123.8200 };

// --- Map setup ---
const map = L.map('map').setView([BUSINESS.lat, BUSINESS.lng], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// --- Markers ---
L.marker([BUSINESS.lat, BUSINESS.lng])
  .addTo(map)
  .bindPopup("<b>Flavour Food Bites</b><br>Colis Street, Tabunok Market, Talisay, Cebu")
  .openPopup();

const motorcycleMarker = L.marker([BUSINESS.lat, BUSINESS.lng], {
  icon: L.divIcon({
    html: 'üèçÔ∏è',
    className: 'motorcycle-emoji',
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  })
}).addTo(map);

L.marker([DELIVERY.lat, DELIVERY.lng], { title: "Your Location" })
  .addTo(map)
  .bindPopup("<b>Delivery Location</b>")
  .openPopup();

let routeLine, routeLatLngs = [];

// --- Toast Notification ---
function showToast(message, color = '#FF6B35') {
  const toast = document.createElement('div');
  toast.textContent = message;
  Object.assign(toast.style, {
    position: 'fixed',
    bottom: '30px',
    left: '50%',
    transform: 'translateX(-50%)',
    background: color,
    color: '#fff',
    padding: '12px 20px',
    borderRadius: '10px',
    fontWeight: '600',
    fontSize: '15px',
    zIndex: '9999',
    boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
    opacity: '0',
    transition: 'opacity 0.4s ease, bottom 0.4s ease'
  });
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    toast.style.opacity = '1';
    toast.style.bottom = '50px';
  });
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.bottom = '30px';
    setTimeout(() => toast.remove(), 500);
  }, 3500);
}

// --- Sound setup ---
const sound = new Audio('https://cdn.pixabay.com/audio/2023/03/16/audio_61a1a6e81d.mp3');
sound.volume = 1.0;

// --- Fetch Route ---
function fetchRoute(callback) {
  const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${BUSINESS.lng},${BUSINESS.lat}&end=${DELIVERY.lng},${DELIVERY.lat}`;
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const coords = data.features[0].geometry.coordinates;
      routeLatLngs = coords.map(c => [c[1], c[0]]);
      callback(routeLatLngs);
    })
    .catch(err => console.error('Error fetching route:', err));
}

// --- Draw Route ---
function drawRoute(latlngs) {
  if (routeLine) routeLine.remove();
  routeLine = L.polyline(latlngs, { color: 'red', weight: 5 }).addTo(map);
  map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
}

// --- Animate Marker ---
function animateAlongRoute(marker, latlngs, speed = 0.002) {
  if (!latlngs || latlngs.length < 2) return;
  let i = 0, progress = 0;
  function move() {
    if (i >= latlngs.length - 1) return;
    const [lat1, lng1] = latlngs[i];
    const [lat2, lng2] = latlngs[i + 1];
    progress += speed;
    if (progress >= 1) { progress = 0; i++; }
    const lat = lat1 + (lat2 - lat1) * progress;
    const lng = lng1 + (lng2 - lng1) * progress;
    marker.setLatLng([lat, lng]);
    requestAnimationFrame(move);
  }
  move();
}

// --- Handle Status ---
function handleStatus(status) {
  if (!status) return;
  console.log("Status:", status);
  switch (status) {
    case 'pending':
      showToast("üïì Your order is pending confirmation.", "#888");
      motorcycleMarker.setLatLng([BUSINESS.lat, BUSINESS.lng]);
      break;
    case 'preparing':
      showToast("üë®‚Äçüç≥ Your order is being prepared.", "#FFA500");
      sound.play();
      motorcycleMarker.setLatLng([BUSINESS.lat, BUSINESS.lng]);
      break;
    case 'on_the_way':
      showToast("üö¥ Your order is on the way!", "#FF6B35");
      sound.play();
      animateAlongRoute(motorcycleMarker, routeLatLngs, 0.003);
      break;
    case 'delivered':
      showToast("‚úÖ Your order has been delivered!", "#28A745");
      sound.play();
      motorcycleMarker.setLatLng([DELIVERY.lat, DELIVERY.lng]);
      break;
    default:
      console.log("Unknown status:", status);
  }
}

// --- Initialize map & route ---
fetchRoute(latlngs => {
  drawRoute(latlngs);
  const activeDelivery = localStorage.getItem('activeDelivery');
  if (activeDelivery) handleStatus(activeDelivery);
});

// --- Detect changes from other tabs ---
window.addEventListener('storage', e => {
  if (e.key === 'activeDelivery') handleStatus(e.newValue);
});

// --- Detect same-tab changes (fix for same browser bar) ---
setInterval(() => {
  const current = localStorage.getItem('activeDelivery');
  if (current !== window.lastStatus) {
    window.lastStatus = current;
    handleStatus(current);
  }
}, 2000);
</script>

</body>
</html>
